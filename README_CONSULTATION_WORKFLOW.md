# 상담 워크플로우 기능 설정 가이드

## 개요
상담 관리 시스템에 워크플로우 기능을 추가했습니다. 이 기능을 사용하려면 먼저 데이터베이스에 필요한 테이블들을 생성해야 합니다.

## 설정 방법

### 1. Supabase 대시보드 접속
1. [Supabase 대시보드](https://supabase.com/dashboard)에 로그인
2. 프로젝트 선택
3. 왼쪽 메뉴에서 **SQL Editor** 클릭

### 2. 워크플로우 테이블 생성
1. 프로젝트 루트의 `create_consultation_workflow_schema.sql` 파일을 열어서 내용을 복사
2. Supabase SQL Editor에 붙여넣기
3. **Run** 버튼 클릭하여 실행

### 3. 테이블 생성 확인
다음 테이블들이 생성되었는지 확인:
- `consultation_workflows` - 워크플로우 템플릿
- `consultation_workflow_steps` - 워크플로우 단계
- `consultation_workflow_executions` - 워크플로우 실행 로그
- `consultation_workflow_step_executions` - 단계별 실행 로그

### 4. 애플리케이션 새로고침
테이블 생성 후 애플리케이션을 새로고침하면 워크플로우 기능을 사용할 수 있습니다.

## 워크플로우 기능 사용법

### 워크플로우 생성
1. **상담 관리** → **워크플로우** 탭으로 이동
2. **새 워크플로우 추가** 버튼 클릭
3. 워크플로우 기본 정보 입력:
   - 이름 (한국어/영어)
   - 설명 (한국어/영어)
   - 카테고리, 상품, 채널 선택
4. **단계 추가** 버튼으로 워크플로우 단계 구성
5. 각 단계별 설정:
   - 단계 이름
   - 단계 타입 (액션, 결정, 조건, 템플릿, 수동)
   - 액션 타입 (템플릿 전송, 질문하기, 응답 대기, 에스컬레이션, 상담 종료)
   - 연결할 템플릿 선택
6. **저장** 버튼 클릭

### 워크플로우 관리
- **활성화/비활성화**: 워크플로우 사용 여부 설정
- **편집**: 워크플로우 내용 수정
- **삭제**: 워크플로우 제거
- **기본 워크플로우**: 자동으로 적용될 기본 워크플로우 설정

## 워크플로우 단계 타입

### 1. 액션 (Action)
실제 작업을 수행하는 단계
- **템플릿 전송**: 기존 Q&A 템플릿을 고객에게 전송
- **질문하기**: 고객에게 질문을 던짐
- **응답 대기**: 고객의 응답을 기다림
- **에스컬레이션**: 상급자에게 상담 이관
- **상담 종료**: 상담을 마무리

### 2. 결정 (Decision)
조건에 따라 다음 단계를 결정하는 분기점
- **고객 선택**: 고객의 선택에 따른 분기
- **응답 분석**: 고객 응답 분석 결과에 따른 분기
- **시간 기반**: 시간 경과에 따른 분기
- **우선순위 기반**: 우선순위에 따른 분기
- **에스컬레이션 확인**: 에스컬레이션 필요 여부 판단

### 3. 조건 (Condition) 🔍
특정 조건을 확인하는 단계 - **새로운 기능!**

#### 조건 타입별 설명:
- **고객 응답**: 고객의 특정 응답 확인 (예: "예", "아니오")
- **시간 경과**: 상담 시작 후 경과 시간 확인 (분 단위)
- **상품 매칭**: 문의 상품이 특정 상품과 일치하는지 확인
- **채널 매칭**: 상담 채널이 특정 채널과 일치하는지 확인
- **카테고리 매칭**: 문의 카테고리가 특정 카테고리와 일치하는지 확인
- **언어 선호도**: 고객의 언어 선호도 확인 (ko, en 등)
- **에스컬레이션 필요**: 에스컬레이션이 필요한 상황인지 확인
- **사용자 정의 필드**: 커스텀 필드 값 존재 여부 확인

#### 조건문 사용 예시:
```
조건 타입: 언어 선호도
조건 값: ko
→ 고객이 한국어를 선호하면 다음 단계로, 아니면 대안 단계로
```

### 4. 템플릿 (Template)
기존 Q&A 템플릿을 활용하는 단계
- FAQ 템플릿 재사용
- 인사말 템플릿 사용
- 마무리 템플릿 적용

### 5. 수동 (Manual)
상담원이 수동으로 처리하는 단계
- 특별한 상황 처리
- 복잡한 문의 대응
- 개별 맞춤 상담

## 샘플 워크플로우 예시

### 일반 문의 처리 워크플로우
1. **인사말 전송** (액션 - 템플릿 전송)
2. **문의 내용 확인** (액션 - 질문하기)
3. **적절한 답변 선택** (결정)
4. **답변 전송** (액션 - 템플릿 전송)
5. **추가 도움 필요 여부 확인** (결정)
6. **상담 마무리** (액션 - 상담 종료)

### 예약 문의 처리 워크플로우
1. **인사말 전송** (액션 - 템플릿 전송)
2. **예약 정보 확인** (액션 - 질문하기)
3. **예약 가능 여부 확인** (조건)
4. **예약 진행 또는 대안 제시** (결정)
5. **예약 완료 또는 재안내** (액션)
6. **상담 마무리** (액션 - 상담 종료)

### 조건문 예시 워크플로우 🔍
1. **인사말 전송** (액션 - 템플릿 전송)
2. **언어 확인** (조건 - 언어 선호도: ko)
   - 조건 만족 → 단계 3 (한국어 응답)
   - 조건 불만족 → 단계 4 (영어 응답)
3. **한국어 응답** (액션 - 템플릿 전송)
4. **영어 응답** (액션 - 템플릿 전송)
5. **상품 매칭 확인** (조건 - 상품 매칭: MDGCSUNRISE)
   - 조건 만족 → 단계 6 (특별 상품 안내)
   - 조건 불만족 → 단계 7 (일반 상품 안내)
6. **특별 상품 안내** (액션 - 템플릿 전송)
7. **일반 상품 안내** (액션 - 템플릿 전송)
8. **시간 경과 확인** (조건 - 시간 경과: 30분)
   - 조건 만족 → 단계 9 (에스컬레이션)
   - 조건 불만족 → 단계 10 (상담 마무리)
9. **에스컬레이션** (액션 - 에스컬레이션)
10. **상담 마무리** (액션 - 상담 종료)

## 조건문 사용법 🔍

### 조건문 생성 방법
1. **워크플로우 편집**에서 **단계 추가** 클릭
2. **단계 타입**을 **"조건"**으로 선택
3. **조건 타입** 선택:
   - 고객 응답: 고객의 특정 응답 확인
   - 시간 경과: 상담 시간 경과 확인
   - 상품 매칭: 특정 상품과의 일치 여부
   - 채널 매칭: 특정 채널과의 일치 여부
   - 카테고리 매칭: 특정 카테고리와의 일치 여부
   - 언어 선호도: 고객 언어 선호도 확인
   - 에스컬레이션 필요: 에스컬레이션 필요 여부
   - 사용자 정의 필드: 커스텀 필드 확인
4. **조건 값** 입력 (예: "예", "30", "MDGCSUNRISE")
5. **조건 설명** 작성
6. **다음 단계 설정**:
   - 성공 시 다음 단계: 조건이 만족될 때 이동할 단계
   - 실패 시 다음 단계: 조건이 불만족될 때 이동할 단계

### 조건문 실행 로직
- 조건문 단계에서 시스템이 자동으로 조건을 평가
- 조건이 만족되면 **성공 시 다음 단계**로 이동
- 조건이 불만족되면 **실패 시 다음 단계**로 이동
- 조건 평가 결과는 실행 로그에 기록됨

### 조건문 활용 예시

#### 1. 언어별 응답 분기
```
조건 타입: 언어 선호도
조건 값: ko
→ 한국어 선호 시 한국어 템플릿, 아니면 영어 템플릿
```

#### 2. 상품별 맞춤 안내
```
조건 타입: 상품 매칭
조건 값: MDGCSUNRISE
→ 밤도깨비 투어 문의 시 특별 안내, 아니면 일반 안내
```

#### 3. 시간 기반 에스컬레이션
```
조건 타입: 시간 경과
조건 값: 30
→ 30분 초과 시 상급자 이관, 아니면 계속 상담
```

#### 4. 고객 응답 기반 분기
```
조건 타입: 고객 응답
조건 값: 예
→ 고객이 "예"라고 답하면 예약 진행, 아니면 재안내
```

## 문제 해결

### 테이블이 생성되지 않는 경우
1. Supabase 프로젝트 권한 확인
2. SQL 문법 오류 확인
3. 기존 테이블과의 충돌 확인

### 워크플로우가 작동하지 않는 경우
1. 테이블 생성 확인
2. RLS (Row Level Security) 정책 확인
3. 브라우저 캐시 삭제 후 새로고침

### 오류 메시지가 나타나는 경우
- `PGRST205` 오류: 테이블이 존재하지 않음 → 테이블 생성 필요
- `PGRST301` 오류: 권한 부족 → RLS 정책 확인
- `PGRST400` 오류: 잘못된 요청 → 데이터 형식 확인

## 추가 정보

워크플로우 기능은 상담원의 업무 효율성을 높이고 일관된 고객 서비스를 제공하기 위해 설계되었습니다. 각 단계는 기존 Q&A 템플릿과 연동되어 있어 재사용성이 높습니다.

문의사항이 있으시면 개발팀에 연락해주세요.

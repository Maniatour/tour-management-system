# 애뉴얼 패스 구현 완료 문서

## 구현 완료 사항

### 1. 가격 계산 서비스 생성 ✅
- **파일**: `src/lib/annualPassPricingService.ts`
- **기능**:
  - 애뉴얼 패스 구매자: $250
  - 동행자: $0 (최대 3명 per pass, 구매자 포함 최대 4인)
  - 다중 캐년 통합 처리
  - 조건부 가격 계산
  - 검증 로직

### 2. BookingFlow 가격 계산 로직 통합 ✅
- **파일**: `src/components/booking/BookingFlow.tsx`
- **변경 사항**:
  - `calculateChoicesPrice()` 함수에 애뉴얼 패스 로직 추가
  - 애뉴얼 패스 모드와 일반 모드 구분
  - 다중 캐년 처리

### 3. UI 조건부 로직 구현 ✅
- **파일**: `src/components/booking/BookingFlow.tsx`
- **기능**:
  - 애뉴얼 패스 구매자 선택 시 일반 입장료 옵션 비활성화
  - 애뉴얼 패스 구매자 없이는 동행자 옵션 비활성화
  - 동행자 수량 제한 (최대 3명 per pass)

### 4. 검증 로직 구현 ✅
- **파일**: `src/components/booking/BookingFlow.tsx`
- **기능**:
  - `validateAnnualPassSelection()` 함수 추가
  - 애뉴얼 패스 + 일반 입장료 동시 선택 방지
  - 동행자 수량 검증
  - 총 인원 수 검증
  - `handleNext()` 및 `handleAddToCart()`에 검증 통합

## 사용 방법

### 1. 템플릿 생성 (통합 옵션)

1. **통합 옵션 > 초이스 관리** 접근
2. **그룹 추가** 클릭
3. 다음 정보 입력:
   - 그룹 이름 (영문): `national_park_fee` 또는 `grand_canyon_fee`
   - 그룹 이름 (한글): `국립공원 입장료` 또는 `그랜드캐년 입장료`
   - 초이스 타입: `single` (단일 선택)
   - 필수 여부: `true`
   - 최소/최대 선택 수: `1`

4. **템플릿 추가**로 옵션 추가:
   - 미국 거주자 ($8)
   - 비 거주자 ($100)
   - 애뉴얼 패스 구매자 ($250)
   - 애뉴얼 패스 동행자 ($0)

### 2. 상품별 초이스 구성

**밤도깨비 투어:**
1. 상품 편집 > 초이스 관리
2. 템플릿에서 "국립공원 입장료" 불러오기
3. 그랜드캐년 입장료 그룹 생성
4. 옵션 추가 (템플릿에서 불러오기)

**그랜드서클 투어:**
1. 상품 편집 > 초이스 관리
2. 템플릿에서 "국립공원 입장료" 불러오기
3. 다음 그룹 생성:
   - 그랜드캐년 입장료
   - 자이언캐년 입장료
   - 브라이스 캐년 입장료
4. 각 그룹에 옵션 추가 (템플릿에서 불러오기)

### 3. 동적 가격 설정

각 상품별로 날짜별 가격 설정:
- 일반 입장료: `choices_pricing`에서 설정
- 애뉴얼 패스: 가격 계산 로직에서 자동 처리 ($250)

## 가격 계산 로직

### 애뉴얼 패스 모드
```
총 가격 = (애뉴얼 패스 구매자 수 × $250) + (동행자 수 × $0)
동행자 최대 수 = 애뉴얼 패스 구매자 수 × 3
커버 인원 = 애뉴얼 패스 구매자 수 + 동행자 수 (최대 4인 per pass)
```

### 일반 입장료 모드
```
총 가격 = (미국 거주자 수 × $8) + (비 거주자 수 × $100)
```

### 다중 캐년 처리
- 애뉴얼 패스 1개로 모든 캐년 커버
- 각 캐년별로 개별 입장료를 내거나 애뉴얼 패스로 통합 커버

## 검증 규칙

1. **애뉴얼 패스 + 일반 입장료 동시 선택 불가**
   - 애뉴얼 패스 구매자가 선택되면 일반 입장료 옵션 비활성화
   - 일반 입장료가 선택되면 애뉴얼 패스 옵션 비활성화

2. **동행자 수량 제한**
   - 애뉴얼 패스 구매자 1명당 최대 3명의 동행자
   - 동행자는 애뉴얼 패스 구매자 없이 선택 불가

3. **총 인원 수 검증**
   - 선택한 인원 수가 총 인원 수를 초과할 수 없음

## 파일 구조

```
src/
├── lib/
│   └── annualPassPricingService.ts  # 애뉴얼 패스 가격 계산 서비스
├── components/
│   ├── booking/
│   │   └── BookingFlow.tsx          # 예약 플로우 (가격 계산, UI 로직, 검증)
│   └── customer/
│       └── InvoiceModal.tsx          # 인보이스 모달 (기존 로직 유지)
└── docs/
    ├── COMPLEX_CHOICE_SCENARIOS.md   # 시나리오 분석 문서
    └── ANNUAL_PASS_IMPLEMENTATION.md # 구현 완료 문서 (본 문서)
```

## 다음 단계 (선택 사항)

1. **InvoiceModal 통합**
   - InvoiceModal에도 애뉴얼 패스 로직 통합 (현재는 BookingFlow만 구현)

2. **다중 캐년 UI 개선**
   - 그랜드서클 투어에서 애뉴얼 패스 선택 시 모든 캐년에 자동 적용되는 것을 UI에 표시

3. **가격 표시 개선**
   - 애뉴얼 패스 선택 시 "구매자 포함 최대 4인까지 커버" 메시지 표시

4. **동적 가격 연동**
   - 동적 가격 시스템과 완전히 통합하여 날짜별로 다른 가격 적용

## 참고 사항

- 현재 구현은 `option_name` 또는 `option_name_ko`에 "annual", "pass", "buyer", "companion" 키워드가 포함되어 있는지로 판단합니다.
- 더 정확한 매칭을 위해서는 `option_key` 필드를 사용하는 것을 권장합니다.
- 다중 캐년 처리 시 각 캐년 그룹의 이름에 "grand", "zion", "bryce", "canyon", "fee", "입장료" 키워드가 포함되어 있는지로 판단합니다.


'use client'

import { useState, useEffect } from 'react'
import { FileText, Mail, Download, Eye } from 'lucide-react'
import { generateTemplateContext } from '@/lib/templateContext'
import { renderTemplateString } from '@/lib/template'

interface SimpleDocumentGeneratorProps {
  reservationId: string
  customerName: string
  productName: string
  tourDate: string
  pickupTime: string
  pickupLocation: string
}

export default function SimpleDocumentGenerator({
  reservationId,
  customerName,
  productName,
  tourDate,
  pickupTime,
  pickupLocation
}: SimpleDocumentGeneratorProps) {
  const [generating, setGenerating] = useState(false)
  const [previewDoc, setPreviewDoc] = useState<null | 'voucher' | 'pickup'>(null)
  const [previewLanguage, setPreviewLanguage] = useState<'ko' | 'en'>('ko')
  const [generatedContent, setGeneratedContent] = useState<{
    voucher: { ko: string; en: string }
    pickup: { ko: string; en: string }
  }>({ 
    voucher: { ko: '', en: '' }, 
    pickup: { ko: '', en: '' } 
  })
  const [autoGenerated, setAutoGenerated] = useState(false)
  const [customerLanguage, setCustomerLanguage] = useState<'ko' | 'en'>('ko')

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ìë™ ìƒì„±
  useEffect(() => {
    if (reservationId && !autoGenerated) {
      autoGenerateDocuments()
    }
  }, [reservationId, autoGenerated])

  // ìë™ ë¬¸ì„œ ìƒì„±
  const autoGenerateDocuments = async () => {
    if (autoGenerated) return
    
    setGenerating(true)
    setAutoGenerated(true)
    
    try {
      // ë¨¼ì € ê³ ê° ì–¸ì–´ í™•ì¸
      await detectCustomerLanguage()
      
      // íˆ¬ì–´ ë°”ìš°ì²˜ì™€ í”½ì—… ì•ˆë‚´ë¥¼ í•œêµ­ì–´ì™€ ì˜ì–´ë¡œ ëª¨ë‘ ìƒì„±
      await Promise.all([
        generateDocument('voucher', true, 'ko'),
        generateDocument('voucher', true, 'en'),
        generateDocument('pickup', true, 'ko'),
        generateDocument('pickup', true, 'en')
      ])
      
      console.log('ë‹¤êµ­ì–´ ë¬¸ì„œ ìë™ ìƒì„± ì™„ë£Œ')
    } catch (error) {
      console.error('ë‹¤êµ­ì–´ ë¬¸ì„œ ìë™ ìƒì„± ì˜¤ë¥˜:', error)
    } finally {
      setGenerating(false)
    }
  }

  // ê³ ê° ì–¸ì–´ ê°ì§€
  const detectCustomerLanguage = async () => {
    try {
      const context = await generateTemplateContext(reservationId, 'ko')
      if (context?.customer?.language) {
        const lang = context.customer.language.toLowerCase()
        setCustomerLanguage(lang === 'en' ? 'en' : 'ko')
        console.log('ê³ ê° ì–¸ì–´ ê°ì§€:', lang === 'en' ? 'ì˜ì–´' : 'í•œêµ­ì–´')
      }
    } catch (error) {
      console.warn('ê³ ê° ì–¸ì–´ ê°ì§€ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error)
      setCustomerLanguage('ko')
    }
  }

  // ê°„ë‹¨í•œ í…œí”Œë¦¿ë“¤
  const templates = {
    voucher_ko: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 2px solid #2563eb; border-radius: 10px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #2563eb; margin: 0;">ğŸ« íˆ¬ì–´ ë°”ìš°ì²˜</h1>
          <p style="color: #666; margin: 5px 0;">Tour Voucher</p>
          <p style="color: #999; font-size: 12px; margin: 5px 0;">ì˜ˆì•½ë²ˆí˜¸: {{reservation.id}}</p>
        </div>
        
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ì˜ˆì•½ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê³ ê°ëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.phone}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì´ë©”ì¼:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.email}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì˜ˆì•½ ìƒíƒœ:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.status}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ìƒí’ˆ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ìƒí’ˆëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_ko}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì˜ë¬¸ëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_en}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì¹´í…Œê³ ë¦¬:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.category}} - {{product.sub_category}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">íˆ¬ì–´ ë‚ ì§œ:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.tour_date}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">íˆ¬ì–´ ì‹œê°„:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.tour_time}}</td>
            </tr>
          </table>
        </div>

        <!-- Tour Course ì„¹ì…˜ -->
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">ğŸ—ºï¸ íˆ¬ì–´ ì½”ìŠ¤</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{tour_course_info}}
          </div>
        </div>

        <!-- Tour Duration ì„¹ì…˜ -->
        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">â° íˆ¬ì–´ ì‹œê°„</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ì´ íˆ¬ì–´ ì‹œê°„:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 18px; font-weight: bold;">{{product.duration}}ì‹œê°„</td>
            </tr>
          </table>
        </div>

        <!-- Tour Schedule ì„¹ì…˜ -->
        <div style="background: #f3e8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #7c3aed; margin-top: 0;">ğŸ“… íˆ¬ì–´ ìŠ¤ì¼€ì¤„</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{tour_schedule_customer_view}}
          </div>
        </div>

        <!-- Tour Information ì„¹ì…˜ -->
        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">â„¹ï¸ íˆ¬ì–´ ìƒì„¸ ì •ë³´</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{tour_information_details}}
          </div>
        </div>

        <!-- Cancellation Policy ì„¹ì…˜ -->
        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #dc2626; margin-top: 0;">ğŸ“‹ ì·¨ì†Œ ì •ì±…</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{cancellation_policy}}
          </div>
        </div>

        <!-- Inclusions ì„¹ì…˜ -->
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">âœ… í¬í•¨ ì‚¬í•­ (INCLUSIONS)</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{inclusions}}
          </div>
        </div>

        <!-- Exclusions ì„¹ì…˜ -->
        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #dc2626; margin-top: 0;">âŒ ë¶ˆí¬í•¨ ì‚¬í•­ (EXCLUSIONS)</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{exclusions}}
          </div>
        </div>

        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">í”½ì—… ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">í”½ì—… ì‹œê°„:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.pickup_time}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… ì¥ì†Œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.display}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… ìœ„ì¹˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.pick_up_location}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì£¼ì†Œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.address}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">íˆ¬ì–´ ì¸ì›</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ì„±ì¸:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.adults}}ëª…</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì•„ë™:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.child}}ëª…</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìœ ì•„:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.infant}}ëª…</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì´ ì¸ì›:</td>
              <td style="padding: 8px 0; color: #111827; font-weight: bold;">{{reservation.total_people}}ëª…</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #92400e; margin-top: 0;">ğŸ“‹ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­</h3>
          <ul style="color: #92400e; margin: 0; padding-left: 20px;">
            <li>íˆ¬ì–´ ë‹¹ì¼ í”½ì—… ì‹œê°„ 10ë¶„ ì „ê¹Œì§€ í”½ì—… ì¥ì†Œì— ë„ì°©í•´ ì£¼ì„¸ìš”</li>
            <li>ì‹ ë¶„ì¦ì„ ì§€ì°¸í•´ ì£¼ì„¸ìš”</li>
            <li>ë‚ ì”¨ì— ë”°ë¼ ì¼ì •ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì—°ë½ì£¼ì„¸ìš”</li>
            <li>ì´ ë°”ìš°ì²˜ë¥¼ íˆ¬ì–´ ë‹¹ì¼ ê°€ì´ë“œì—ê²Œ ì œì‹œí•´ ì£¼ì„¸ìš”</li>
          </ul>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px;">
          <p>ê°ì‚¬í•©ë‹ˆë‹¤! ì¦ê±°ìš´ íˆ¬ì–´ ë˜ì„¸ìš”! ğŸ‰</p>
          <p style="margin: 5px 0; font-size: 12px;">ë¬¸ì˜: {{channel.name}}</p>
        </div>
      </div>
    `,
    
    voucher_en: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 2px solid #2563eb; border-radius: 10px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #2563eb; margin: 0;">ğŸ« Tour Voucher</h1>
          <p style="color: #666; margin: 5px 0;">íˆ¬ì–´ ë°”ìš°ì²˜</p>
          <p style="color: #999; font-size: 12px; margin: 5px 0;">Reservation No: {{reservation.id}}</p>
        </div>
        
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">Reservation Information</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Customer Name:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Contact:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.phone}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Email:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.email}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Status:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.status}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">Tour Information</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Tour Name:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_en}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Korean Name:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_ko}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Category:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.category}} - {{product.sub_category}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Tour Date:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.tour_date}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Tour Time:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.tour_time}}</td>
            </tr>
          </table>
        </div>

        <!-- Tour Course Section -->
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">ğŸ—ºï¸ Tour Course</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{tour_course_info}}
          </div>
        </div>

        <!-- Tour Duration Section -->
        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">â° Tour Duration</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Total Tour Duration:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 18px; font-weight: bold;">{{product.duration}} hours</td>
            </tr>
          </table>
        </div>

        <!-- Tour Schedule Section -->
        <div style="background: #f3e8ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #7c3aed; margin-top: 0;">ğŸ“… Tour Schedule</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{tour_schedule_customer_view}}
          </div>
        </div>

        <!-- Tour Information Section -->
        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">â„¹ï¸ Tour Information</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{tour_information_details}}
          </div>
        </div>

        <!-- Cancellation Policy Section -->
        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #dc2626; margin-top: 0;">ğŸ“‹ Cancellation Policy</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{cancellation_policy}}
          </div>
        </div>

        <!-- Inclusions Section -->
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">âœ… Inclusions</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{inclusions}}
          </div>
        </div>

        <!-- Exclusions Section -->
        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #dc2626; margin-top: 0;">âŒ Exclusions</h2>
          <div style="color: #111827; line-height: 1.6;">
            {{exclusions}}
          </div>
        </div>

        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">Pickup Information</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Pickup Time:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.pickup_time}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Pickup Location:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.display}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Pickup Point:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.pick_up_location}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Address:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.address}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">Tour Participants</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Adults:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.adults}} people</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Children:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.child}} people</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Infants:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.infant}} people</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Total:</td>
              <td style="padding: 8px 0; color: #111827; font-weight: bold;">{{reservation.total_people}} people</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #92400e; margin-top: 0;">ğŸ“‹ Important Information</h3>
          <ul style="color: #92400e; margin: 0; padding-left: 20px;">
            <li>Please arrive at the pickup location 10 minutes before the scheduled pickup time</li>
            <li>Please bring your ID card</li>
            <li>The schedule may change depending on weather conditions</li>
            <li>Please contact us if you have any questions</li>
            <li>Please present this voucher to your guide on the day of the tour</li>
          </ul>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px;">
          <p>Thank you! Have a wonderful tour! ğŸ‰</p>
          <p style="margin: 5px 0; font-size: 12px;">Contact: {{channel.name}}</p>
        </div>
      </div>
    `,
    
    pickup_ko: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 2px solid #059669; border-radius: 10px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #059669; margin: 0;">ğŸšŒ í”½ì—… ì•ˆë‚´</h1>
          <p style="color: #666; margin: 5px 0;">Pickup Information</p>
          <p style="color: #999; font-size: 12px; margin: 5px 0;">ì˜ˆì•½ë²ˆí˜¸: {{reservation.id}}</p>
        </div>
        
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">ê³ ê° ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê³ ê°ëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.phone}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">íˆ¬ì–´ ë‚ ì§œ:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.tour_date}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìƒí’ˆëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_ko}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #dbeafe; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ğŸ“ í”½ì—… ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">í”½ì—… ì‹œê°„:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 20px; font-weight: bold; color: #dc2626;">{{reservation.pickup_time}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… í˜¸í…”:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.hotel_name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… ìœ„ì¹˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.pick_up_location}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì£¼ì†Œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.address}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì•ˆë‚´:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.description_ko}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">ğŸš— ì°¨ëŸ‰ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ì°¨ëŸ‰ ìœ í˜•:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.type || 'íˆ¬ì–´ ë²„ìŠ¤'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì°¨ëŸ‰ ë²ˆí˜¸:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.plate_number || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìš´ì „ì‚¬:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_name || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_phone || 'TBD'}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ğŸ‘¨â€ğŸ« ê°€ì´ë“œ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê°€ì´ë“œëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.name || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì–¸ì–´:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.language || 'í•œêµ­ì–´'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ê²½í—˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.experience || 'í’ë¶€í•œ ê²½í—˜'}}</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #92400e; margin-top: 0;">âš ï¸ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­</h3>
          <ul style="color: #92400e; margin: 0; padding-left: 20px;">
            <li><strong>í”½ì—… ì‹œê°„ 10ë¶„ ì „ê¹Œì§€ ë„ì°©í•´ ì£¼ì„¸ìš”</strong></li>
            <li>ë²„ìŠ¤ëŠ” ì •ì‹œì— ì¶œë°œí•©ë‹ˆë‹¤ (ëŠ¦ìœ¼ì‹¤ ê²½ìš° ë‹¤ìŒ í”½ì—… ì¥ì†Œë¡œ ì´ë™)</li>
            <li>ì‹ ë¶„ì¦ì„ ì§€ì°¸í•´ ì£¼ì„¸ìš”</li>
            <li>ë‚ ì”¨ì— ë”°ë¼ ì¼ì •ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>ê¸´ê¸‰ìƒí™© ì‹œ ê°€ì´ë“œ ë˜ëŠ” ìš´ì „ì‚¬ì—ê²Œ ì—°ë½ì£¼ì„¸ìš”</li>
            <li>íˆ¬ì–´ ë°”ìš°ì²˜ë¥¼ ê°€ì´ë“œì—ê²Œ ì œì‹œí•´ ì£¼ì„¸ìš”</li>
          </ul>
        </div>

        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #047857; margin-top: 0;">ğŸ“ ì—°ë½ì²˜</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê°€ì´ë“œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìš´ì „ì‚¬:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ê³ ê°ì„¼í„°:</td>
              <td style="padding: 8px 0; color: #111827;">{{channel.contact_phone || 'TBD'}}</td>
            </tr>
          </table>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px;">
          <p>ì•ˆì „í•˜ê³  ì¦ê±°ìš´ íˆ¬ì–´ ë˜ì„¸ìš”! ğŸšŒâœ¨</p>
          <p style="margin: 5px 0; font-size: 12px;">ë¬¸ì˜: {{channel.name}}</p>
        </div>
      </div>
    `,
    
    pickup_en: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 2px solid #059669; border-radius: 10px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #059669; margin: 0;">ğŸšŒ Pickup Information</h1>
          <p style="color: #666; margin: 5px 0;">í”½ì—… ì•ˆë‚´</p>
          <p style="color: #999; font-size: 12px; margin: 5px 0;">Reservation No: {{reservation.id}}</p>
        </div>
        
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">Customer Information</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Customer Name:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Contact:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.phone}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Tour Date:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.tour_date}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Tour Name:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_en}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #dbeafe; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ğŸ“ Pickup Information</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Pickup Time:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 20px; font-weight: bold; color: #dc2626;">{{reservation.pickup_time}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Pickup Hotel:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.hotel_name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Pickup Point:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.pick_up_location}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Address:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.address}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Instructions:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.description_en}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">ğŸš— Vehicle Information</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Vehicle Type:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.type || 'Tour Bus'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">License Plate:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.plate_number || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Driver:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_name || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Driver Contact:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_phone || 'TBD'}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ğŸ‘¨â€ğŸ« Guide Information</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Guide Name:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.name || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Guide Contact:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Language:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.language || 'English'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Experience:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.experience || 'Experienced'}}</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #92400e; margin-top: 0;">âš ï¸ Important Information</h3>
          <ul style="color: #92400e; margin: 0; padding-left: 20px;">
            <li><strong>Please arrive 10 minutes before the pickup time</strong></li>
            <li>The bus will depart on time (if late, please go to the next pickup location)</li>
            <li>Please bring your ID card</li>
            <li>The schedule may change depending on weather conditions</li>
            <li>In case of emergency, please contact the guide or driver</li>
            <li>Please present your tour voucher to the guide</li>
          </ul>
        </div>

        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #047857; margin-top: 0;">ğŸ“ Contact Information</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">Guide:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Driver:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">Customer Service:</td>
              <td style="padding: 8px 0; color: #111827;">{{channel.contact_phone || 'TBD'}}</td>
            </tr>
          </table>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px;">
          <p>Have a safe and wonderful tour! ğŸšŒâœ¨</p>
          <p style="margin: 5px 0; font-size: 12px;">Contact: {{channel.name}}</p>
        </div>
      </div>
    `
  }

  const generateDocument = async (type: 'voucher' | 'pickup', isAuto = false, language: 'ko' | 'en' = 'ko') => {
    if (!isAuto) {
      setGenerating(true)
    }
    
    try {
      console.log(`${type} ë¬¸ì„œ ìƒì„± ì‹œì‘ (${language})...`)
      
      // í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©)
      let context = null
      try {
        context = await generateTemplateContext(reservationId, language)
        console.log('í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ:', context ? Object.keys(context) : 'null')
      } catch (error) {
        console.warn('í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error)
        console.log('ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©')
        // ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ì œê³µ
        context = {
          reservation: {
            id: reservationId,
            tour_date: tourDate,
            pickup_time: pickupTime,
            tour_time: '09:00',
            adults: 2,
            child: 0,
            infant: 0,
            total_people: 2,
            total_price: 100000,
            status: 'confirmed'
          },
          customer: {
            name: customerName || 'ê³ ê°',
            email: 'customer@example.com',
            phone: '010-0000-0000',
            language: language
          },
          product: {
            name_ko: productName || 'íˆ¬ì–´ ìƒí’ˆ',
            name_en: 'Tour Product',
            category: 'íˆ¬ì–´',
            sub_category: 'ì¼ë°˜',
            duration: 8
          },
          channel: {
            name: 'ì¼ë°˜ ì±„ë„',
            type: 'direct',
            contact_phone: '02-0000-0000'
          },
          pickup: {
            display: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
            hotel_name: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
            pick_up_location: 'í˜¸í…” ë¡œë¹„',
            address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬',
            description_ko: 'í˜¸í…” ë¡œë¹„ì—ì„œ í”½ì—…',
            description_en: 'Pickup at hotel lobby'
          },
          vehicle: {
            type: 'íˆ¬ì–´ ë²„ìŠ¤',
            plate_number: 'TBD',
            driver_name: 'TBD',
            driver_phone: 'TBD'
          },
          guide: {
            name: 'TBD',
            phone: 'TBD',
            language: language === 'ko' ? 'í•œêµ­ì–´' : 'English',
            experience: language === 'ko' ? 'í’ë¶€í•œ ê²½í—˜' : 'Experienced'
          },
          // ìƒˆë¡œìš´ ì„¹ì…˜ë“¤ ì¶”ê°€
          tour_course_info: language === 'ko' ? 
            'â€¢ ì„œìš¸ ì‹œì²­\nâ€¢ ê²½ë³µê¶\nâ€¢ ì¸ì‚¬ë™\nâ€¢ ëª…ë™\nâ€¢ ë‚¨ì‚°íƒ€ì›Œ' : 
            'â€¢ Seoul City Hall\nâ€¢ Gyeongbokgung Palace\nâ€¢ Insadong\nâ€¢ Myeongdong\nâ€¢ N Seoul Tower',
          tour_schedule_customer_view: language === 'ko' ?
            '09:00 - í˜¸í…” í”½ì—…\n10:00 - ê²½ë³µê¶ ê´€ëŒ\n12:00 - ì ì‹¬ ì‹ì‚¬\n14:00 - ì¸ì‚¬ë™ ì‡¼í•‘\n16:00 - ë‚¨ì‚°íƒ€ì›Œ\n18:00 - í˜¸í…” ë„ì°©' :
            '09:00 - Hotel pickup\n10:00 - Gyeongbokgung Palace tour\n12:00 - Lunch\n14:00 - Insadong shopping\n16:00 - N Seoul Tower\n18:00 - Hotel arrival',
          tour_information_details: language === 'ko' ?
            'â€¢ ìƒí’ˆ ì„¤ëª…: ì„œìš¸ì˜ ì£¼ìš” ê´€ê´‘ì§€ë¥¼ ë‘˜ëŸ¬ë³´ëŠ” í•˜ë£¨ íˆ¬ì–´\nâ€¢ í”½ì—…/ë“œë¡­ ì •ë³´: í˜¸í…”ì—ì„œ í”½ì—… ë° ë“œë¡­ì˜¤í”„\nâ€¢ ìˆ˜í•˜ë¬¼ ì •ë³´: ê°œì¸ ì†Œì§€í’ˆë§Œ ê°€ëŠ¥\nâ€¢ íˆ¬ì–´ ìš´ì˜ ì •ë³´: ì „ë¬¸ ê°€ì´ë“œì™€ í•¨ê»˜ ì§„í–‰\nâ€¢ ì¤€ë¹„ ì‚¬í•­: í¸ì•ˆí•œ ì‹ ë°œê³¼ ê°„ë‹¨í•œ ê°œì¸ ì†Œì§€í’ˆ\nâ€¢ ì†Œê·¸ë£¹ ì •ë³´: ìµœëŒ€ 15ëª… ì†Œê·¸ë£¹ íˆ¬ì–´\nâ€¢ ì•ˆë‚´ì‚¬í•­: ë‚ ì”¨ì— ë”°ë¼ ì¼ì •ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤' :
            'â€¢ Product Description: Full-day tour of Seoul\'s major attractions\nâ€¢ Pickup/Drop Info: Hotel pickup and drop-off\nâ€¢ Luggage Info: Personal belongings only\nâ€¢ Tour Operation: Led by professional guide\nâ€¢ Preparation: Comfortable shoes and personal items\nâ€¢ Small Group: Maximum 15 people\nâ€¢ Notice: Schedule may change due to weather',
          cancellation_policy: language === 'ko' ?
            'â€¢ íˆ¬ì–´ 3ì¼ ì „: 100% í™˜ë¶ˆ\nâ€¢ íˆ¬ì–´ 1ì¼ ì „: 50% í™˜ë¶ˆ\nâ€¢ íˆ¬ì–´ ë‹¹ì¼: í™˜ë¶ˆ ë¶ˆê°€\nâ€¢ ì²œì¬ì§€ë³€ìœ¼ë¡œ ì¸í•œ ì·¨ì†Œ: 100% í™˜ë¶ˆ' :
            'â€¢ 3 days before tour: 100% refund\nâ€¢ 1 day before tour: 50% refund\nâ€¢ On tour day: No refund\nâ€¢ Cancellation due to natural disasters: 100% refund',
          inclusions: language === 'ko' ?
            'â€¢ ì „ë¬¸ ê°€ì´ë“œ ì„œë¹„ìŠ¤\nâ€¢ êµí†µí¸ (ì™•ë³µ)\nâ€¢ ëª¨ë“  ì…ì¥ë£Œ\nâ€¢ ì ì‹¬ ì‹ì‚¬\nâ€¢ ì—¬í–‰ì ë³´í—˜' :
            'â€¢ Professional guide service\nâ€¢ Round-trip transportation\nâ€¢ All entrance fees\nâ€¢ Lunch\nâ€¢ Travel insurance',
          exclusions: language === 'ko' ?
            'â€¢ ê°œì¸ ê²½ë¹„\nâ€¢ ìˆ™ë°•ë¹„\nâ€¢ í•­ê³µë£Œ\nâ€¢ ê°œì¸ ë³´í—˜\nâ€¢ ê¸°ë…í’ˆ ë° ì‡¼í•‘' :
            'â€¢ Personal expenses\nâ€¢ Accommodation\nâ€¢ Airfare\nâ€¢ Personal insurance\nâ€¢ Souvenirs and shopping'
        }
      }
      
      if (!context) {
        console.error('í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨')
        return
      }
      
      // ì–¸ì–´ì— ë”°ë¥¸ í…œí”Œë¦¿ ì„ íƒ
      const templateKey = `${type}_${language}`
      const template = templates[templateKey as keyof typeof templates]
      
      if (!template) {
        console.error(`í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${templateKey}`)
        return
      }
      
      // í…œí”Œë¦¿ ë Œë”ë§
      const renderedContent = renderTemplateString(template, context)
      
      setGeneratedContent(prev => ({
        ...prev,
        [type]: {
          ...prev[type],
          [language]: renderedContent
        }
      }))
      
      console.log(`${type} ë¬¸ì„œ ìƒì„± ì™„ë£Œ (${language})`)
    } catch (error) {
      console.error(`${type} ë¬¸ì„œ ìƒì„± ì˜¤ë¥˜ (${language}):`, error)
      // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ ë¬¸ì„œ ìƒì„±
      const fallbackContext = {
        reservation: {
          id: reservationId,
          tour_date: tourDate,
          pickup_time: pickupTime,
          tour_time: '09:00',
          adults: 2,
          child: 0,
          infant: 0,
          total_people: 2,
          total_price: 100000,
          status: 'confirmed'
        },
        customer: {
          name: customerName || 'ê³ ê°',
          email: 'customer@example.com',
          phone: '010-0000-0000',
          language: language
        },
        product: {
          name_ko: productName || 'íˆ¬ì–´ ìƒí’ˆ',
          name_en: 'Tour Product',
          category: 'íˆ¬ì–´',
          sub_category: 'ì¼ë°˜'
        },
        channel: {
          name: 'ì¼ë°˜ ì±„ë„',
          type: 'direct',
          contact_phone: '02-0000-0000'
        },
        pickup: {
          display: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
          hotel_name: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
          pick_up_location: 'í˜¸í…” ë¡œë¹„',
          address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬',
          description_ko: 'í˜¸í…” ë¡œë¹„ì—ì„œ í”½ì—…',
          description_en: 'Pickup at hotel lobby'
        },
        vehicle: {
          type: 'íˆ¬ì–´ ë²„ìŠ¤',
          plate_number: 'TBD',
          driver_name: 'TBD',
          driver_phone: 'TBD'
        },
        guide: {
          name: 'TBD',
          phone: 'TBD',
          language: language === 'ko' ? 'í•œêµ­ì–´' : 'English',
          experience: language === 'ko' ? 'í’ë¶€í•œ ê²½í—˜' : 'Experienced'
        }
      }
      
      const templateKey = `${type}_${language}`
      const template = templates[templateKey as keyof typeof templates]
      
      if (template) {
        const renderedContent = renderTemplateString(template, fallbackContext)
        setGeneratedContent(prev => ({
          ...prev,
          [type]: {
            ...prev[type],
            [language]: renderedContent
          }
        }))
      }
    } finally {
      if (!isAuto) {
        setGenerating(false)
      }
    }
  }

  const downloadDocument = (type: 'voucher' | 'pickup', language: 'ko' | 'en' = 'ko') => {
    const content = generatedContent[type][language]
    if (!content) return
    
    const blob = new Blob([content], { type: 'text/html' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${type === 'voucher' ? 'íˆ¬ì–´ë°”ìš°ì²˜' : 'í”½ì—…ì•ˆë‚´'}_${language}_${customerName}_${tourDate}.html`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  const sendEmail = (type: 'voucher' | 'pickup', language: 'ko' | 'en' = 'ko') => {
    const content = generatedContent[type][language]
    if (!content) return
    
    const subject = type === 'voucher' 
      ? (language === 'ko' ? 'íˆ¬ì–´ ë°”ìš°ì²˜' : 'Tour Voucher')
      : (language === 'ko' ? 'í”½ì—… ì•ˆë‚´' : 'Pickup Information')
    const body = encodeURIComponent(content)
    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${body}`
    window.open(mailtoLink)
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-lg font-semibold text-gray-900">ğŸ“„ ê°„í¸ ë¬¸ì„œ ìƒì„±</h3>
          <p className="text-sm text-gray-600">
            ê³ ê° ì–¸ì–´: <span className="font-medium">{customerLanguage === 'ko' ? 'í•œêµ­ì–´' : 'English'}</span>
          </p>
        </div>
        {autoGenerated && (
          <div className="flex items-center gap-2 text-sm text-green-600">
            <div className="w-2 h-2 bg-green-500 rounded-full"></div>
            ë‹¤êµ­ì–´ ìë™ ìƒì„± ì™„ë£Œ
          </div>
        )}
      </div>
      
      {generating && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div className="flex items-center gap-3">
            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            <span className="text-blue-700">ë¬¸ì„œë¥¼ ìë™ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
          </div>
        </div>
      )}
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* íˆ¬ì–´ ë°”ìš°ì²˜ */}
        <div className="border rounded-lg p-4 bg-white">
          <div className="flex items-center gap-2 mb-3">
            <FileText className="w-5 h-5 text-blue-600" />
            <h4 className="font-medium text-gray-900">íˆ¬ì–´ ë°”ìš°ì²˜</h4>
            {(generatedContent.voucher.ko || generatedContent.voucher.en) && (
              <div className="w-2 h-2 bg-green-500 rounded-full"></div>
            )}
          </div>
          
          <div className="space-y-2">
            <div className="flex gap-2">
              <button
                onClick={() => generateDocument('voucher', false, 'ko')}
                disabled={generating}
                className="flex-1 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 text-sm"
              >
                {generating ? 'ìƒì„± ì¤‘...' : 'í•œêµ­ì–´ ìƒì„±'}
              </button>
              <button
                onClick={() => generateDocument('voucher', false, 'en')}
                disabled={generating}
                className="flex-1 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 text-sm"
              >
                {generating ? 'ìƒì„± ì¤‘...' : 'English ìƒì„±'}
              </button>
            </div>
            
            {(generatedContent.voucher.ko || generatedContent.voucher.en) && (
              <div className="space-y-2">
                {/* í•œêµ­ì–´ ë²„ì „ */}
                {generatedContent.voucher.ko && (
                  <div className="border rounded p-2 bg-gray-50">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-gray-700">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span>
                      <div className="flex gap-1">
                        <button
                          onClick={() => {
                            setPreviewDoc('voucher')
                            setPreviewLanguage('ko')
                          }}
                          className="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs flex items-center gap-1"
                        >
                          <Eye className="w-3 h-3" />
                          ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button
                          onClick={() => downloadDocument('voucher', 'ko')}
                          className="px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-xs flex items-center gap-1"
                        >
                          <Download className="w-3 h-3" />
                          ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button
                          onClick={() => sendEmail('voucher', 'ko')}
                          className="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs flex items-center gap-1"
                        >
                          <Mail className="w-3 h-3" />
                          ì´ë©”ì¼
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* ì˜ì–´ ë²„ì „ */}
                {generatedContent.voucher.en && (
                  <div className="border rounded p-2 bg-gray-50">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-gray-700">ğŸ‡ºğŸ‡¸ English</span>
                      <div className="flex gap-1">
                        <button
                          onClick={() => {
                            setPreviewDoc('voucher')
                            setPreviewLanguage('en')
                          }}
                          className="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs flex items-center gap-1"
                        >
                          <Eye className="w-3 h-3" />
                          Preview
                        </button>
                        <button
                          onClick={() => downloadDocument('voucher', 'en')}
                          className="px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-xs flex items-center gap-1"
                        >
                          <Download className="w-3 h-3" />
                          Download
                        </button>
                        <button
                          onClick={() => sendEmail('voucher', 'en')}
                          className="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs flex items-center gap-1"
                        >
                          <Mail className="w-3 h-3" />
                          Email
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* í”½ì—… ì•ˆë‚´ */}
        <div className="border rounded-lg p-4 bg-white">
          <div className="flex items-center gap-2 mb-3">
            <FileText className="w-5 h-5 text-green-600" />
            <h4 className="font-medium text-gray-900">í”½ì—… ì•ˆë‚´</h4>
            {(generatedContent.pickup.ko || generatedContent.pickup.en) && (
              <div className="w-2 h-2 bg-green-500 rounded-full"></div>
            )}
          </div>
          
          <div className="space-y-2">
            <div className="flex gap-2">
              <button
                onClick={() => generateDocument('pickup', false, 'ko')}
                disabled={generating}
                className="flex-1 px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 text-sm"
              >
                {generating ? 'ìƒì„± ì¤‘...' : 'í•œêµ­ì–´ ìƒì„±'}
              </button>
              <button
                onClick={() => generateDocument('pickup', false, 'en')}
                disabled={generating}
                className="flex-1 px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 text-sm"
              >
                {generating ? 'ìƒì„± ì¤‘...' : 'English ìƒì„±'}
              </button>
            </div>
            
            {(generatedContent.pickup.ko || generatedContent.pickup.en) && (
              <div className="space-y-2">
                {/* í•œêµ­ì–´ ë²„ì „ */}
                {generatedContent.pickup.ko && (
                  <div className="border rounded p-2 bg-gray-50">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-gray-700">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span>
                      <div className="flex gap-1">
                        <button
                          onClick={() => {
                            setPreviewDoc('pickup')
                            setPreviewLanguage('ko')
                          }}
                          className="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs flex items-center gap-1"
                        >
                          <Eye className="w-3 h-3" />
                          ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button
                          onClick={() => downloadDocument('pickup', 'ko')}
                          className="px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-xs flex items-center gap-1"
                        >
                          <Download className="w-3 h-3" />
                          ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button
                          onClick={() => sendEmail('pickup', 'ko')}
                          className="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs flex items-center gap-1"
                        >
                          <Mail className="w-3 h-3" />
                          ì´ë©”ì¼
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* ì˜ì–´ ë²„ì „ */}
                {generatedContent.pickup.en && (
                  <div className="border rounded p-2 bg-gray-50">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-gray-700">ğŸ‡ºğŸ‡¸ English</span>
                      <div className="flex gap-1">
                        <button
                          onClick={() => {
                            setPreviewDoc('pickup')
                            setPreviewLanguage('en')
                          }}
                          className="px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs flex items-center gap-1"
                        >
                          <Eye className="w-3 h-3" />
                          Preview
                        </button>
                        <button
                          onClick={() => downloadDocument('pickup', 'en')}
                          className="px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-xs flex items-center gap-1"
                        >
                          <Download className="w-3 h-3" />
                          Download
                        </button>
                        <button
                          onClick={() => sendEmail('pickup', 'en')}
                          className="px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs flex items-center gap-1"
                        >
                          <Mail className="w-3 h-3" />
                          Email
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */}
      {previewDoc && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <h2 className="text-xl font-bold text-gray-900">
                    {previewDoc === 'voucher' ? 'íˆ¬ì–´ ë°”ìš°ì²˜ ë¯¸ë¦¬ë³´ê¸°' : 'í”½ì—… ì•ˆë‚´ ë¯¸ë¦¬ë³´ê¸°'}
                  </h2>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setPreviewLanguage('ko')}
                      className={`px-3 py-1 rounded text-sm ${
                        previewLanguage === 'ko' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ğŸ‡°ğŸ‡· í•œêµ­ì–´
                    </button>
                    <button
                      onClick={() => setPreviewLanguage('en')}
                      className={`px-3 py-1 rounded text-sm ${
                        previewLanguage === 'en' 
                          ? 'bg-blue-600 text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      ğŸ‡ºğŸ‡¸ English
                    </button>
                  </div>
                </div>
                <button
                  onClick={() => setPreviewDoc(null)}
                  className="text-gray-400 hover:text-gray-600 text-2xl"
                >
                  Ã—
                </button>
              </div>
              
              <div className="border rounded-lg p-6 bg-white overflow-y-auto max-h-[70vh]">
                <div dangerouslySetInnerHTML={{ __html: generatedContent[previewDoc][previewLanguage] }} />
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

'use client'

import { useState, useEffect } from 'react'
import { FileText, Mail, Download, Eye } from 'lucide-react'
import { generateTemplateContext } from '@/lib/templateContext'
import { renderTemplateString } from '@/lib/template'

interface SimpleDocumentGeneratorProps {
  reservationId: string
  customerName: string
  productName: string
  tourDate: string
  pickupTime: string
  pickupLocation: string
}

export default function SimpleDocumentGenerator({
  reservationId,
  customerName,
  productName,
  tourDate,
  pickupTime,
  pickupLocation
}: SimpleDocumentGeneratorProps) {
  const [generating, setGenerating] = useState(false)
  const [previewDoc, setPreviewDoc] = useState<null | 'voucher' | 'pickup'>(null)
  const [generatedContent, setGeneratedContent] = useState<{
    voucher: string
    pickup: string
  }>({ voucher: '', pickup: '' })
  const [autoGenerated, setAutoGenerated] = useState(false)

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ìë™ ìƒì„±
  useEffect(() => {
    if (reservationId && !autoGenerated) {
      autoGenerateDocuments()
    }
  }, [reservationId, autoGenerated])

  // ìë™ ë¬¸ì„œ ìƒì„±
  const autoGenerateDocuments = async () => {
    if (autoGenerated) return
    
    setGenerating(true)
    setAutoGenerated(true)
    
    try {
      // íˆ¬ì–´ ë°”ìš°ì²˜ì™€ í”½ì—… ì•ˆë‚´ë¥¼ ë™ì‹œì— ìƒì„±
      await Promise.all([
        generateDocument('voucher', true),
        generateDocument('pickup', true)
      ])
      
      console.log('ìë™ ë¬¸ì„œ ìƒì„± ì™„ë£Œ')
    } catch (error) {
      console.error('ìë™ ë¬¸ì„œ ìƒì„± ì˜¤ë¥˜:', error)
    } finally {
      setGenerating(false)
    }
  }

  // ê°„ë‹¨í•œ í…œí”Œë¦¿ë“¤
  const templates = {
    voucher: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 2px solid #2563eb; border-radius: 10px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #2563eb; margin: 0;">ğŸ« íˆ¬ì–´ ë°”ìš°ì²˜</h1>
          <p style="color: #666; margin: 5px 0;">Tour Voucher</p>
          <p style="color: #999; font-size: 12px; margin: 5px 0;">ì˜ˆì•½ë²ˆí˜¸: {{reservation.id}}</p>
        </div>
        
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ì˜ˆì•½ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê³ ê°ëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.phone}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì´ë©”ì¼:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.email}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì˜ˆì•½ ìƒíƒœ:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.status}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ìƒí’ˆ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ìƒí’ˆëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_ko}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì˜ë¬¸ëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_en}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì¹´í…Œê³ ë¦¬:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.category}} - {{product.sub_category}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">íˆ¬ì–´ ë‚ ì§œ:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.tour_date}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">íˆ¬ì–´ ì‹œê°„:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.tour_time}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">í”½ì—… ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">í”½ì—… ì‹œê°„:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.pickup_time}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… ì¥ì†Œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.display}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… ìœ„ì¹˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.pick_up_location}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì£¼ì†Œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.address}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">íˆ¬ì–´ ì¸ì›</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ì„±ì¸:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.adults}}ëª…</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì•„ë™:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.child}}ëª…</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìœ ì•„:</td>
              <td style="padding: 8px 0; color: #111827;">{{reservation.infant}}ëª…</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì´ ì¸ì›:</td>
              <td style="padding: 8px 0; color: #111827; font-weight: bold;">{{reservation.total_people}}ëª…</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #92400e; margin-top: 0;">ğŸ“‹ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­</h3>
          <ul style="color: #92400e; margin: 0; padding-left: 20px;">
            <li>íˆ¬ì–´ ë‹¹ì¼ í”½ì—… ì‹œê°„ 10ë¶„ ì „ê¹Œì§€ í”½ì—… ì¥ì†Œì— ë„ì°©í•´ ì£¼ì„¸ìš”</li>
            <li>ì‹ ë¶„ì¦ì„ ì§€ì°¸í•´ ì£¼ì„¸ìš”</li>
            <li>ë‚ ì”¨ì— ë”°ë¼ ì¼ì •ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì—°ë½ì£¼ì„¸ìš”</li>
            <li>ì´ ë°”ìš°ì²˜ë¥¼ íˆ¬ì–´ ë‹¹ì¼ ê°€ì´ë“œì—ê²Œ ì œì‹œí•´ ì£¼ì„¸ìš”</li>
          </ul>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px;">
          <p>ê°ì‚¬í•©ë‹ˆë‹¤! ì¦ê±°ìš´ íˆ¬ì–´ ë˜ì„¸ìš”! ğŸ‰</p>
          <p style="margin: 5px 0; font-size: 12px;">ë¬¸ì˜: {{channel.name}}</p>
        </div>
      </div>
    `,
    
    pickup: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 2px solid #059669; border-radius: 10px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <h1 style="color: #059669; margin: 0;">ğŸšŒ í”½ì—… ì•ˆë‚´</h1>
          <p style="color: #666; margin: 5px 0;">Pickup Information</p>
          <p style="color: #999; font-size: 12px; margin: 5px 0;">ì˜ˆì•½ë²ˆí˜¸: {{reservation.id}}</p>
        </div>
        
        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #047857; margin-top: 0;">ê³ ê° ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê³ ê°ëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{customer.phone}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">íˆ¬ì–´ ë‚ ì§œ:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 16px; font-weight: bold;">{{reservation.tour_date}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìƒí’ˆëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{product.name_ko}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #dbeafe; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ğŸ“ í”½ì—… ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">í”½ì—… ì‹œê°„:</td>
              <td style="padding: 8px 0; color: #111827; font-size: 20px; font-weight: bold; color: #dc2626;">{{reservation.pickup_time}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… í˜¸í…”:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.hotel_name}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">í”½ì—… ìœ„ì¹˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.pick_up_location}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì£¼ì†Œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.address}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì•ˆë‚´:</td>
              <td style="padding: 8px 0; color: #111827;">{{pickup.description_ko}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #92400e; margin-top: 0;">ğŸš— ì°¨ëŸ‰ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ì°¨ëŸ‰ ìœ í˜•:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.type || 'íˆ¬ì–´ ë²„ìŠ¤'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì°¨ëŸ‰ ë²ˆí˜¸:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.plate_number || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìš´ì „ì‚¬:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_name || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_phone || 'TBD'}}</td>
            </tr>
          </table>
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #1e40af; margin-top: 0;">ğŸ‘¨â€ğŸ« ê°€ì´ë“œ ì •ë³´</h2>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê°€ì´ë“œëª…:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.name || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì—°ë½ì²˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ì–¸ì–´:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.language || 'í•œêµ­ì–´'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ê²½í—˜:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.experience || 'í’ë¶€í•œ ê²½í—˜'}}</td>
            </tr>
          </table>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #92400e; margin-top: 0;">âš ï¸ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­</h3>
          <ul style="color: #92400e; margin: 0; padding-left: 20px;">
            <li><strong>í”½ì—… ì‹œê°„ 10ë¶„ ì „ê¹Œì§€ ë„ì°©í•´ ì£¼ì„¸ìš”</strong></li>
            <li>ë²„ìŠ¤ëŠ” ì •ì‹œì— ì¶œë°œí•©ë‹ˆë‹¤ (ëŠ¦ìœ¼ì‹¤ ê²½ìš° ë‹¤ìŒ í”½ì—… ì¥ì†Œë¡œ ì´ë™)</li>
            <li>ì‹ ë¶„ì¦ì„ ì§€ì°¸í•´ ì£¼ì„¸ìš”</li>
            <li>ë‚ ì”¨ì— ë”°ë¼ ì¼ì •ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li>ê¸´ê¸‰ìƒí™© ì‹œ ê°€ì´ë“œ ë˜ëŠ” ìš´ì „ì‚¬ì—ê²Œ ì—°ë½ì£¼ì„¸ìš”</li>
            <li>íˆ¬ì–´ ë°”ìš°ì²˜ë¥¼ ê°€ì´ë“œì—ê²Œ ì œì‹œí•´ ì£¼ì„¸ìš”</li>
          </ul>
        </div>

        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #047857; margin-top: 0;">ğŸ“ ì—°ë½ì²˜</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 30%;">ê°€ì´ë“œ:</td>
              <td style="padding: 8px 0; color: #111827;">{{guide.phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ìš´ì „ì‚¬:</td>
              <td style="padding: 8px 0; color: #111827;">{{vehicle.driver_phone || 'TBD'}}</td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">ê³ ê°ì„¼í„°:</td>
              <td style="padding: 8px 0; color: #111827;">{{channel.contact_phone || 'TBD'}}</td>
            </tr>
          </table>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px;">
          <p>ì•ˆì „í•˜ê³  ì¦ê±°ìš´ íˆ¬ì–´ ë˜ì„¸ìš”! ğŸšŒâœ¨</p>
          <p style="margin: 5px 0; font-size: 12px;">ë¬¸ì˜: {{channel.name}}</p>
        </div>
      </div>
    `
  }

  const generateDocument = async (type: 'voucher' | 'pickup', isAuto = false) => {
    if (!isAuto) {
      setGenerating(true)
    }
    
    try {
      console.log(`${type} ë¬¸ì„œ ìƒì„± ì‹œì‘...`)
      
      // í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©)
      let context = null
      try {
        context = await generateTemplateContext(reservationId, 'ko')
        console.log('í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ:', context ? Object.keys(context) : 'null')
      } catch (error) {
        console.warn('í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error)
        console.log('ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš©')
        // ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° ì œê³µ
        context = {
          reservation: {
            id: reservationId,
            tour_date: tourDate,
            pickup_time: pickupTime,
            tour_time: '09:00',
            adults: 2,
            child: 0,
            infant: 0,
            total_people: 2,
            total_price: 100000,
            status: 'confirmed'
          },
          customer: {
            name: customerName || 'ê³ ê°',
            email: 'customer@example.com',
            phone: '010-0000-0000',
            language: 'ko'
          },
          product: {
            name_ko: productName || 'íˆ¬ì–´ ìƒí’ˆ',
            name_en: 'Tour Product',
            category: 'íˆ¬ì–´',
            sub_category: 'ì¼ë°˜'
          },
          channel: {
            name: 'ì¼ë°˜ ì±„ë„',
            type: 'direct',
            contact_phone: '02-0000-0000'
          },
          pickup: {
            display: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
            hotel_name: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
            pick_up_location: 'í˜¸í…” ë¡œë¹„',
            address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬',
            description_ko: 'í˜¸í…” ë¡œë¹„ì—ì„œ í”½ì—…',
            description_en: 'Pickup at hotel lobby'
          },
          vehicle: {
            type: 'íˆ¬ì–´ ë²„ìŠ¤',
            plate_number: 'TBD',
            driver_name: 'TBD',
            driver_phone: 'TBD'
          },
          guide: {
            name: 'TBD',
            phone: 'TBD',
            language: 'í•œêµ­ì–´',
            experience: 'í’ë¶€í•œ ê²½í—˜'
          }
        }
      }
      
      if (!context) {
        console.error('í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨')
        return
      }
      
      // í…œí”Œë¦¿ ë Œë”ë§
      const renderedContent = renderTemplateString(templates[type], context)
      
      setGeneratedContent(prev => ({
        ...prev,
        [type]: renderedContent
      }))
      
      console.log(`${type} ë¬¸ì„œ ìƒì„± ì™„ë£Œ`)
    } catch (error) {
      console.error(`${type} ë¬¸ì„œ ìƒì„± ì˜¤ë¥˜:`, error)
      // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ ë¬¸ì„œ ìƒì„±
      const fallbackContext = {
        reservation: {
          id: reservationId,
          tour_date: tourDate,
          pickup_time: pickupTime,
          tour_time: '09:00',
          adults: 2,
          child: 0,
          infant: 0,
          total_people: 2,
          total_price: 100000,
          status: 'confirmed'
        },
        customer: {
          name: customerName || 'ê³ ê°',
          email: 'customer@example.com',
          phone: '010-0000-0000',
          language: 'ko'
        },
        product: {
          name_ko: productName || 'íˆ¬ì–´ ìƒí’ˆ',
          name_en: 'Tour Product',
          category: 'íˆ¬ì–´',
          sub_category: 'ì¼ë°˜'
        },
        channel: {
          name: 'ì¼ë°˜ ì±„ë„',
          type: 'direct',
          contact_phone: '02-0000-0000'
        },
        pickup: {
          display: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
          hotel_name: pickupLocation || 'ê¸°ë³¸ í”½ì—… í˜¸í…”',
          pick_up_location: 'í˜¸í…” ë¡œë¹„',
          address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬',
          description_ko: 'í˜¸í…” ë¡œë¹„ì—ì„œ í”½ì—…',
          description_en: 'Pickup at hotel lobby'
        },
        vehicle: {
          type: 'íˆ¬ì–´ ë²„ìŠ¤',
          plate_number: 'TBD',
          driver_name: 'TBD',
          driver_phone: 'TBD'
        },
        guide: {
          name: 'TBD',
          phone: 'TBD',
          language: 'í•œêµ­ì–´',
          experience: 'í’ë¶€í•œ ê²½í—˜'
        }
      }
      
      const renderedContent = renderTemplateString(templates[type], fallbackContext)
      setGeneratedContent(prev => ({
        ...prev,
        [type]: renderedContent
      }))
    } finally {
      if (!isAuto) {
        setGenerating(false)
      }
    }
  }

  const downloadDocument = (type: 'voucher' | 'pickup') => {
    const content = generatedContent[type]
    if (!content) return
    
    const blob = new Blob([content], { type: 'text/html' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${type === 'voucher' ? 'íˆ¬ì–´ë°”ìš°ì²˜' : 'í”½ì—…ì•ˆë‚´'}_${customerName}_${tourDate}.html`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  const sendEmail = (type: 'voucher' | 'pickup') => {
    const content = generatedContent[type]
    if (!content) return
    
    const subject = type === 'voucher' ? 'íˆ¬ì–´ ë°”ìš°ì²˜' : 'í”½ì—… ì•ˆë‚´'
    const body = encodeURIComponent(content)
    const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${body}`
    window.open(mailtoLink)
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-gray-900">ğŸ“„ ê°„í¸ ë¬¸ì„œ ìƒì„±</h3>
        {autoGenerated && (
          <div className="flex items-center gap-2 text-sm text-green-600">
            <div className="w-2 h-2 bg-green-500 rounded-full"></div>
            ìë™ ìƒì„± ì™„ë£Œ
          </div>
        )}
      </div>
      
      {generating && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div className="flex items-center gap-3">
            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
            <span className="text-blue-700">ë¬¸ì„œë¥¼ ìë™ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
          </div>
        </div>
      )}
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* íˆ¬ì–´ ë°”ìš°ì²˜ */}
        <div className="border rounded-lg p-4 bg-white">
          <div className="flex items-center gap-2 mb-3">
            <FileText className="w-5 h-5 text-blue-600" />
            <h4 className="font-medium text-gray-900">íˆ¬ì–´ ë°”ìš°ì²˜</h4>
            {generatedContent.voucher && (
              <div className="w-2 h-2 bg-green-500 rounded-full"></div>
            )}
          </div>
          
          <div className="space-y-2">
            <button
              onClick={() => generateDocument('voucher')}
              disabled={generating}
              className="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 text-sm"
            >
              {generating ? 'ìƒì„± ì¤‘...' : generatedContent.voucher ? 'ë‹¤ì‹œ ìƒì„±' : 'ë°”ìš°ì²˜ ìƒì„±'}
            </button>
            
            {generatedContent.voucher && (
              <div className="flex gap-2">
                <button
                  onClick={() => setPreviewDoc(previewDoc === 'voucher' ? null : 'voucher')}
                  className="flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm flex items-center justify-center gap-1"
                >
                  <Eye className="w-4 h-4" />
                  ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button
                  onClick={() => downloadDocument('voucher')}
                  className="flex-1 px-3 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm flex items-center justify-center gap-1"
                >
                  <Download className="w-4 h-4" />
                  ë‹¤ìš´ë¡œë“œ
                </button>
                <button
                  onClick={() => sendEmail('voucher')}
                  className="flex-1 px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm flex items-center justify-center gap-1"
                >
                  <Mail className="w-4 h-4" />
                  ì´ë©”ì¼
                </button>
              </div>
            )}
          </div>
        </div>

        {/* í”½ì—… ì•ˆë‚´ */}
        <div className="border rounded-lg p-4 bg-white">
          <div className="flex items-center gap-2 mb-3">
            <FileText className="w-5 h-5 text-green-600" />
            <h4 className="font-medium text-gray-900">í”½ì—… ì•ˆë‚´</h4>
            {generatedContent.pickup && (
              <div className="w-2 h-2 bg-green-500 rounded-full"></div>
            )}
          </div>
          
          <div className="space-y-2">
            <button
              onClick={() => generateDocument('pickup')}
              disabled={generating}
              className="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 text-sm"
            >
              {generating ? 'ìƒì„± ì¤‘...' : generatedContent.pickup ? 'ë‹¤ì‹œ ìƒì„±' : 'í”½ì—… ì•ˆë‚´ ìƒì„±'}
            </button>
            
            {generatedContent.pickup && (
              <div className="flex gap-2">
                <button
                  onClick={() => setPreviewDoc(previewDoc === 'pickup' ? null : 'pickup')}
                  className="flex-1 px-3 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm flex items-center justify-center gap-1"
                >
                  <Eye className="w-4 h-4" />
                  ë¯¸ë¦¬ë³´ê¸°
                </button>
                <button
                  onClick={() => downloadDocument('pickup')}
                  className="flex-1 px-3 py-2 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm flex items-center justify-center gap-1"
                >
                  <Download className="w-4 h-4" />
                  ë‹¤ìš´ë¡œë“œ
                </button>
                <button
                  onClick={() => sendEmail('pickup')}
                  className="flex-1 px-3 py-2 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm flex items-center justify-center gap-1"
                >
                  <Mail className="w-4 h-4" />
                  ì´ë©”ì¼
                </button>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */}
      {previewDoc && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div className="p-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-900">
                  {previewDoc === 'voucher' ? 'íˆ¬ì–´ ë°”ìš°ì²˜ ë¯¸ë¦¬ë³´ê¸°' : 'í”½ì—… ì•ˆë‚´ ë¯¸ë¦¬ë³´ê¸°'}
                </h2>
                <button
                  onClick={() => setPreviewDoc(null)}
                  className="text-gray-400 hover:text-gray-600 text-2xl"
                >
                  Ã—
                </button>
              </div>
              
              <div className="border rounded-lg p-6 bg-white overflow-y-auto max-h-[70vh]">
                <div dangerouslySetInnerHTML={{ __html: generatedContent[previewDoc] }} />
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
